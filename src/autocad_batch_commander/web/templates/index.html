<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARAIDEN</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root[data-theme="dark"] {
            --bg-primary: #1b1d23;
            --bg-secondary: #23262e;
            --bg-tertiary: #2a2d36;
            --bg-hover: #31343e;
            --bg-input: #191b20;
            --border: #3a3d47;
            --border-subtle: #2e3139;
            --text-primary: #e4e6eb;
            --text-secondary: #9ca0ab;
            --text-muted: #6b7080;
            --accent: #4da6ff;
            --accent-dim: rgba(77,166,255,0.12);
            --accent-hover: #6db8ff;
            --grid-line: rgba(77,166,255,0.04);
            --grid-line-strong: rgba(77,166,255,0.08);
            --crosshair: rgba(77,166,255,0.15);
            --red: #ff6b6b;
            --orange: #ffa94d;
            --green: #69db7c;
            --cyan: #66d9e8;
            --shadow: rgba(0,0,0,0.3);
            --header-bg: #16181d;
        }
        :root[data-theme="light"] {
            --bg-primary: #f0f1f4;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f7f8fa;
            --bg-hover: #ebedf2;
            --bg-input: #ffffff;
            --border: #d0d3da;
            --border-subtle: #e2e4e9;
            --text-primary: #1a1c24;
            --text-secondary: #5a5e6b;
            --text-muted: #8b8f9c;
            --accent: #2b7de9;
            --accent-dim: rgba(43,125,233,0.08);
            --accent-hover: #1a6dd6;
            --grid-line: rgba(43,125,233,0.03);
            --grid-line-strong: rgba(43,125,233,0.06);
            --crosshair: rgba(43,125,233,0.08);
            --red: #e03131;
            --orange: #e67700;
            --green: #2b8a3e;
            --cyan: #1098ad;
            --shadow: rgba(0,0,0,0.06);
            --header-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: "SF Mono", "Cascadia Code", "JetBrains Mono", "Fira Code", Consolas, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px),
                linear-gradient(var(--grid-line-strong) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line-strong) 1px, transparent 1px);
            background-size: 20px 20px, 20px 20px, 100px 100px, 100px 100px;
            min-height: 100vh;
        }

        /* ── Header / Toolbar ─────────────────────────── */
        header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 4px var(--shadow);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-left: 1rem;
        }
        .logo {
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
        }
        .logo svg { width: 24px; height: 24px; }
        .app-title {
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--text-primary);
        }
        .app-title span { color: var(--accent); }
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-right: 1rem;
        }
        .theme-toggle {
            width: 36px; height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            font-size: 1.1rem;
        }
        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }
        .status-bar {
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 0.3px;
        }
        .status-dot {
            display: inline-block;
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--green);
            margin-right: 4px;
            vertical-align: middle;
        }

        /* ── Layout ──────────────────────────────────── */
        .layout {
            display: flex;
            width: 100%;
            height: calc(100vh - 48px);
        }

        /* ── Sidebar ─────────────────────────────────── */
        .sidebar {
            width: 220px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1rem 0;
            flex-shrink: 0;
            overflow-y: auto;
        }
        .sidebar-section {
            padding: 0 0.75rem;
            margin-bottom: 1.5rem;
        }
        .sidebar-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 0 0.5rem;
            margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.75rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border: 1px solid transparent;
            transition: all 0.15s;
            margin-bottom: 2px;
        }
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .nav-item.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: rgba(77,166,255,0.2);
        }
        .nav-icon {
            width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .nav-icon svg { width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        /* ── Main content ────────────────────────────── */
        .main {
            flex: 1;
            padding: 1.5rem 2rem;
            overflow-y: auto;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .panel-header h2 {
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .panel-header .cmd {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            border: 1px solid var(--border-subtle);
        }

        /* ── Card ─────────────────────────────────────── */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        /* ── Forms ────────────────────────────────────── */
        label {
            display: block;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
        }
        input[type="text"], select {
            width: 100%;
            padding: 0.55rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            margin-bottom: 0.85rem;
            transition: border-color 0.15s;
        }
        input[type="text"]::placeholder { color: var(--text-muted); }
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-dim);
        }
        select { cursor: pointer; }
        select option { background: var(--bg-secondary); color: var(--text-primary); }

        .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: inherit;
            font-weight: 500;
            letter-spacing: 0.3px;
            transition: all 0.15s;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .input-row {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        .input-row .input-group { flex: 1; }
        .input-row .btn { margin-bottom: 0.85rem; white-space: nowrap; }

        /* ── Results panel ────────────────────────────── */
        .results {
            margin-top: 0.75rem;
            max-height: 65vh;
            overflow-y: auto;
        }
        .results::-webkit-scrollbar { width: 6px; }
        .results::-webkit-scrollbar-track { background: transparent; }
        .results::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .results::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .results-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: var(--accent);
            border-bottom: 1px solid var(--border-subtle);
        }
        .results-header .count {
            background: var(--accent-dim);
            padding: 0.1rem 0.5rem;
            border-radius: 3px;
            font-weight: 600;
        }

        /* ── File sections (search results) ──────────── */
        .file-section {
            margin-bottom: 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 5px;
            overflow: hidden;
        }
        .file-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            user-select: none;
        }
        .file-header:hover { background: var(--bg-hover); }
        .file-header .chevron {
            transition: transform 0.2s;
            font-size: 0.6rem;
        }
        .file-header.collapsed .chevron { transform: rotate(-90deg); }
        .file-body { padding: 0.75rem 1rem; }
        .file-body.hidden { display: none; }

        .md-content { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.7; }
        .md-content h1 { font-size: 1.1rem; color: var(--text-primary); margin: 1rem 0 0.4rem; font-weight: 600; }
        .md-content h2 { font-size: 0.95rem; color: var(--text-primary); margin: 0.8rem 0 0.3rem; font-weight: 600; }
        .md-content h3 { font-size: 0.85rem; color: var(--text-primary); margin: 0.6rem 0 0.25rem; font-weight: 600; }
        .md-content strong { color: var(--accent); font-weight: 600; }
        .md-content blockquote {
            border-left: 2px solid var(--accent);
            padding: 0.4rem 0.75rem;
            margin: 0.5rem 0;
            background: var(--accent-dim);
            border-radius: 0 4px 4px 0;
            font-size: 0.78rem;
        }
        .md-content ul, .md-content ol { padding-left: 1.4rem; margin: 0.3rem 0; }
        .md-content li { margin-bottom: 0.15rem; }
        .md-content table { border-collapse: collapse; width: 100%; margin: 0.5rem 0; font-size: 0.78rem; }
        .md-content th, .md-content td { border: 1px solid var(--border); padding: 0.3rem 0.6rem; text-align: left; }
        .md-content th { background: var(--bg-tertiary); color: var(--text-primary); font-weight: 600; }
        .md-content code {
            background: var(--bg-tertiary);
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            font-size: 0.78rem;
        }
        .md-content hr { border: none; border-top: 1px solid var(--border-subtle); margin: 0.75rem 0; }

        .empty { color: var(--text-muted); font-style: italic; font-size: 0.82rem; padding: 1rem 0; }

        /* ── Findings ─────────────────────────────────── */
        .finding {
            border: 1px solid var(--border);
            border-radius: 5px;
            padding: 0.65rem 0.85rem;
            margin-bottom: 0.4rem;
            font-size: 0.82rem;
            background: var(--bg-secondary);
            transition: border-color 0.15s;
        }
        .finding:hover { border-color: var(--text-muted); }
        .finding-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        .finding .rule-id {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.78rem;
        }
        .finding .by-law {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
        }
        .finding .desc { color: var(--text-secondary); margin-bottom: 0.25rem; }
        .finding .threshold {
            font-size: 0.78rem;
            color: var(--cyan);
            font-weight: 500;
        }
        .finding .tags { margin-top: 0.3rem; }
        .finding .tag {
            display: inline-block;
            background: var(--accent-dim);
            color: var(--accent);
            padding: 0.08rem 0.45rem;
            border-radius: 3px;
            font-size: 0.68rem;
            margin-right: 0.25rem;
            letter-spacing: 0.3px;
        }
        .severity-error { border-left: 3px solid var(--red); }
        .severity-warning { border-left: 3px solid var(--orange); }
        .severity-info { border-left: 3px solid var(--cyan); }

        /* ── Rule set chips ──────────────────────────── */
        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }
        .chip {
            padding: 0.4rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-tertiary);
            cursor: pointer;
            font-size: 0.78rem;
            color: var(--text-secondary);
            transition: all 0.15s;
            font-family: inherit;
        }
        .chip:hover { border-color: var(--accent); color: var(--accent); }
        .chip.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* ── Spinner ──────────────────────────────────── */
        .spinner {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-msg {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 1rem 0;
        }

        /* ── Command line (bottom bar) ────────────────── */
        .cmdline {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 28px;
            background: var(--header-bg);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            font-size: 0.68rem;
            color: var(--text-muted);
            gap: 1.5rem;
            z-index: 100;
        }
        .cmdline .coord { color: var(--text-secondary); }

        /* ── Responsive ──────────────────────────────── */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav {
                display: flex !important;
                gap: 0.25rem;
                padding: 0.5rem 1rem;
                overflow-x: auto;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
            }
            .mobile-nav .chip { white-space: nowrap; flex-shrink: 0; }
            .main { padding: 1rem; }
            .input-row { flex-direction: column; }
            .input-row .btn { margin-bottom: 0; }
        }
        @media (min-width: 769px) {
            .mobile-nav { display: none !important; }
        }

        /* Ensure body has bottom padding for cmdline */
        .layout { padding-bottom: 28px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #ubbl.tab-content.active { display: flex; flex-direction: column; height: 100%; }
        #chat.tab-content.active { display: flex; flex-direction: column; height: 100%; }
        #ubbl .panel-header { flex-shrink: 0; }
        #ubbl .loading-msg { flex-shrink: 0; }

        /* ── Setup guide styles ─────────────────────── */
        .guide-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .guide-section-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            user-select: none;
        }
        .guide-section-header:hover { background: var(--bg-hover); }
        .guide-section-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .guide-section-header .step-num {
            background: var(--accent);
            color: #fff;
            width: 22px; height: 22px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .guide-section-header .chevron {
            margin-left: auto;
            transition: transform 0.2s;
            font-size: 0.6rem;
            color: var(--text-muted);
        }
        .guide-section-header.collapsed .chevron { transform: rotate(-90deg); }
        .guide-body { padding: 1rem 1.25rem; }
        .guide-body.hidden { display: none; }
        .guide-body p { font-size: 0.82rem; color: var(--text-secondary); margin-bottom: 0.6rem; }
        .guide-body ul, .guide-body ol { font-size: 0.82rem; color: var(--text-secondary); padding-left: 1.4rem; margin-bottom: 0.6rem; }
        .guide-body li { margin-bottom: 0.3rem; }
        .guide-body h4 {
            font-size: 0.8rem;
            color: var(--text-primary);
            margin: 1rem 0 0.4rem;
            font-weight: 600;
        }
        .code-block {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0 0.75rem;
            font-size: 0.78rem;
            color: var(--cyan);
            overflow-x: auto;
            white-space: pre;
            line-height: 1.7;
            position: relative;
        }
        .code-block .comment { color: var(--text-muted); }
        .code-block .copy-btn {
            position: absolute;
            top: 0.4rem;
            right: 0.4rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-muted);
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            cursor: pointer;
            font-family: inherit;
        }
        .code-block .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
        .config-json {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.75rem 1rem;
            margin: 0.5rem 0 0.75rem;
            font-size: 0.76rem;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre;
            line-height: 1.6;
        }
        .config-json .key { color: var(--accent); }
        .config-json .string { color: var(--green); }
        .config-json .comment { color: var(--text-muted); }
        .badge {
            display: inline-block;
            padding: 0.12rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .badge-win { background: rgba(77,166,255,0.12); color: var(--accent); }
        .badge-mac { background: rgba(105,219,124,0.12); color: var(--green); }
        .badge-all { background: rgba(102,217,232,0.12); color: var(--cyan); }
        .badge-ai { background: rgba(255,169,77,0.15); color: var(--orange); font-size: 0.6rem; padding: 0.1rem 0.4rem; }
        .endpoint-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; margin: 0.5rem 0; }
        .endpoint-table th, .endpoint-table td { border: 1px solid var(--border); padding: 0.35rem 0.65rem; text-align: left; }
        .endpoint-table th { background: var(--bg-tertiary); color: var(--text-primary); font-weight: 600; }
        .endpoint-table td code { background: var(--bg-tertiary); padding: 0.08rem 0.3rem; border-radius: 3px; color: var(--accent); font-size: 0.76rem; }
        .method { font-weight: 600; }
        .method-get { color: var(--green); }
        .method-post { color: var(--orange); }

        /* ── UBBL Browser ─────────────────────────────── */
        .ubbl-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1rem;
            align-items: start;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .ubbl-toc {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 0;
            height: 100%;
            overflow-y: auto;
        }
        .ubbl-toc::-webkit-scrollbar { width: 4px; }
        .ubbl-toc::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .ubbl-toc-header {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            padding: 0.5rem 1rem 0.25rem;
            margin-top: 0.25rem;
        }
        .ubbl-toc-header:first-child { margin-top: 0; }
        .ubbl-toc-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 1rem;
            font-size: 0.78rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            border-left: 2px solid transparent;
        }
        .ubbl-toc-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .ubbl-toc-item.active {
            background: var(--accent-dim);
            color: var(--accent);
            border-left-color: var(--accent);
        }
        .ubbl-toc-item .toc-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .amendment-badge {
            display: inline-block;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            background: rgba(255,169,77,0.15);
            color: var(--orange);
            flex-shrink: 0;
        }
        .new-badge {
            display: inline-block;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.3px;
            background: rgba(105,219,124,0.15);
            color: var(--green);
            flex-shrink: 0;
        }
        .ubbl-content-area {
            min-width: 0;
            overflow-y: auto;
            height: 100%;
        }
        .ubbl-content-area::-webkit-scrollbar { width: 6px; }
        .ubbl-content-area::-webkit-scrollbar-track { background: transparent; }
        .ubbl-content-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .ubbl-content-area::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .ubbl-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .ubbl-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .ubbl-section-body {
            padding: 1rem 1.25rem;
        }
        .ubbl-filter-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        .ubbl-filter-bar input[type="text"] {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        .ubbl-filter-chips {
            display: flex;
            gap: 0.3rem;
        }
        .search-highlight {
            background: rgba(255,169,77,0.3);
            border-radius: 2px;
            padding: 0 1px;
        }
        @media (max-width: 768px) {
            .ubbl-layout {
                grid-template-columns: 1fr;
                overflow: visible;
            }
            .ubbl-toc {
                height: auto;
                max-height: 250px;
            }
            .ubbl-content-area {
                height: auto;
                overflow-y: visible;
            }
            #ubbl.tab-content.active { height: auto; }
        }

        /* ── Sidebar collapsible group ───────────────── */
        .sidebar-label-toggle {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            transition: color 0.15s;
        }
        .sidebar-label-toggle:hover { color: var(--text-secondary); }
        .sidebar-label-toggle .chevron { transition: transform 0.2s; }
        .sidebar-label-toggle.collapsed .chevron { transform: rotate(-90deg); }
        .tools-group.hidden { display: none; }

        /* ── Guide action buttons ────────────────────── */
        .guide-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-family: inherit;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .guide-action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }
        .guide-action-btn.copied {
            border-color: var(--green);
            color: var(--green);
            background: rgba(105,219,124,0.1);
        }

        /* ── Chat UI ─────────────────────────────────── */
        #chat .panel-header { flex-shrink: 0; }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        .chat-msg {
            max-width: 80%;
            padding: 0.65rem 0.9rem;
            border-radius: 8px;
            font-size: 0.82rem;
            line-height: 1.7;
            word-wrap: break-word;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: var(--accent-dim);
            color: var(--text-primary);
            border: 1px solid rgba(77,166,255,0.2);
            border-bottom-right-radius: 2px;
        }
        .chat-msg.assistant {
            align-self: flex-start;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
        }
        .chat-msg.assistant .md-content { font-size: 0.82rem; }
        .chat-msg.assistant .md-content p:first-child { margin-top: 0; }
        .chat-msg.assistant .md-content p:last-child { margin-bottom: 0; }

        .chat-feedback {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.4rem;
        }
        .chat-feedback button {
            background: none;
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            padding: 0.15rem 0.45rem;
            cursor: pointer;
            font-size: 0.72rem;
            color: var(--text-muted);
            transition: all 0.15s;
            font-family: inherit;
        }
        .chat-feedback button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .chat-feedback button.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .chat-typing {
            align-self: flex-start;
            padding: 0.5rem 0.9rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .chat-typing .dots span {
            display: inline-block;
            width: 5px; height: 5px;
            border-radius: 50%;
            background: var(--text-muted);
            margin: 0 1px;
            animation: chatDot 1.4s infinite both;
        }
        .chat-typing .dots span:nth-child(2) { animation-delay: 0.2s; }
        .chat-typing .dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes chatDot {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        .chat-input-area {
            flex-shrink: 0;
            border-top: 1px solid var(--border);
            padding: 0.75rem 0;
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .chat-input-area textarea {
            flex: 1;
            padding: 0.55rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.82rem;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 1.5;
            transition: border-color 0.15s;
        }
        .chat-input-area textarea::placeholder { color: var(--text-muted); }
        .chat-input-area textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-dim);
        }

        .consent-banner {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1.25rem;
            text-align: center;
            margin: auto 0;
        }
        .consent-banner p {
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        .consent-banner .warn {
            font-size: 0.75rem;
            color: var(--orange);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header toolbar -->
    <header>
        <div class="header-left">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="9" x2="9" y2="21"/>
                    <path d="M13 13h4M13 17h4"/>
                </svg>
            </div>
            <span class="app-title"><span>ARA</span>IDEN</span>
        </div>
        <div class="header-right">
            <span class="status-bar"><span class="status-dot"></span>READY</span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode" id="theme-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon-dark" style="display:none;">
                    <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="theme-icon-light">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile nav -->
    <div class="mobile-nav">
        <button class="chip active" data-tab="setup" onclick="switchTab('setup', this)">Setup</button>
        <button class="chip" data-tab="docs" onclick="switchTab('docs', this)">Docs</button>
        <button class="chip" data-tab="chat" onclick="switchTab('chat', this)" id="mobile-nav-chat" style="display:none;">AI Chat</button>
        <button class="chip" data-tab="search" onclick="switchTab('search', this)">Search</button>
        <button class="chip" data-tab="compliance" onclick="switchTab('compliance', this)">Compliance</button>
        <button class="chip" data-tab="rules" onclick="switchTab('rules', this)">Rules</button>
        <button class="chip" data-tab="ubbl" onclick="switchTab('ubbl', this)">UBBL</button>
    </div>

    <div class="layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-label">Product</div>
                <div class="nav-item active" data-tab="setup" onclick="switchTab('setup', this)">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="12" y1="6" x2="12" y2="14"/><polyline points="8 10 12 14 16 10"/></svg></div>
                    Setup Guide
                </div>
                <div class="nav-item" data-tab="docs" onclick="switchTab('docs', this)">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                    Documentation
                </div>
            </div>
            <div class="sidebar-section" id="sidebar-ai-section" style="display:none;">
                <div class="sidebar-label">AI</div>
                <div class="nav-item" data-tab="chat" onclick="switchTab('chat', this)" id="nav-chat">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
                    AI Chat <span class="badge badge-ai" style="margin-left:auto;">AI</span>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label sidebar-label-toggle" onclick="toggleToolsGroup(this)">
                    Tools <span class="chevron" style="font-size:0.5rem; margin-left:0.3rem;">&#9660;</span>
                </div>
                <div class="tools-group">
                    <div class="nav-item" data-tab="search" onclick="switchTab('search', this)">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
                        Regulation Search
                    </div>
                    <div class="nav-item" data-tab="compliance" onclick="switchTab('compliance', this)">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
                        Compliance Check
                    </div>
                    <div class="nav-item" data-tab="rules" onclick="switchTab('rules', this)">
                        <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
                        Rule Browser
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Resources</div>
                <div class="nav-item" data-tab="ubbl" onclick="switchTab('ubbl', this)">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div>
                    UBBL 2021
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Info</div>
                <div class="nav-item" style="cursor:default; font-size:0.72rem; color:var(--text-muted);">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
                    <div>
                        <div style="color:var(--text-secondary)">Malaysian UBBL</div>
                        <div>Fire, Spatial, Access</div>
                    </div>
                </div>
                <div id="sidebar-rule-count" class="nav-item" style="cursor:default; font-size:0.72rem; color:var(--text-muted);">
                    <div class="nav-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg></div>
                    <div>
                        <div style="color:var(--text-secondary);" id="rule-count-text">Loading...</div>
                        <div>Rule sets</div>
                    </div>
                </div>
            </div>
            <div class="sidebar-section" style="border-left:2px solid var(--orange); padding-left:0.6rem; margin:0.5rem 0.75rem;">
                <div class="sidebar-label" style="color:var(--orange);">&#9888; Pre-Release</div>
                <div style="font-size:0.65rem; color:var(--text-muted); line-height:1.5; padding:0.2rem 0;">
                    This tool is in early development and provided as-is for reference purposes only. Always seek professional consultation from qualified architects, engineers, or relevant authorities for regulatory compliance decisions.
                </div>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Author</div>
                <div style="font-size:0.72rem; color:var(--text-muted); padding:0.2rem 0.75rem; line-height:1.6;">
                    <div style="color:var(--text-secondary);">Hazman Hassan</div>
                    <div><a href="https://zemang.my" target="_blank" style="color:var(--accent); text-decoration:none;">zemang.my</a> &middot; <a href="https://github.com/zemang86" target="_blank" style="color:var(--accent); text-decoration:none;">GitHub</a></div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="main">
            <!-- Search Tab -->
            <div id="search" class="tab-content">
                <div class="panel-header">
                    <h2>Regulation Search</h2>
                    <span class="cmd">QUERY</span>
                </div>
                <div class="card">
                    <label for="query-input">Search query</label>
                    <div class="input-row">
                        <div class="input-group">
                            <input type="text" id="query-input" placeholder="e.g. minimum corridor width, fire escape, parking ratio...">
                        </div>
                        <button class="btn" onclick="doSearch()">Search</button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>

            <!-- Compliance Tab -->
            <div id="compliance" class="tab-content">
                <div class="panel-header">
                    <h2>Compliance Checker</h2>
                    <span class="cmd">CHECK</span>
                </div>
                <div class="card">
                    <label for="rule-select">Rule sets (hold Ctrl/Cmd to select multiple)</label>
                    <select id="rule-select" multiple style="height: 110px;"></select>
                    <label for="building-type">Building type (optional)</label>
                    <div class="input-row">
                        <div class="input-group">
                            <input type="text" id="building-type" placeholder="e.g. residential, commercial, office, industrial">
                        </div>
                        <button class="btn" onclick="doCompliance()">Run Check</button>
                    </div>
                </div>
                <div id="compliance-results"></div>
            </div>

            <!-- Rules Tab -->
            <div id="rules" class="tab-content">
                <div class="panel-header">
                    <h2>Rule Browser</h2>
                    <span class="cmd">BROWSE</span>
                </div>
                <div class="card">
                    <label>Select rule set</label>
                    <div class="chip-group" id="rule-set-list"></div>
                </div>
                <div id="rules-results"></div>
            </div>

            <!-- UBBL Browser Tab -->
            <div id="ubbl" class="tab-content">
                <div class="panel-header">
                    <h2>UBBL 2021 Amendment</h2>
                    <span class="cmd">BROWSE</span>
                </div>
                <div class="ubbl-filter-bar">
                    <input type="text" id="ubbl-search" placeholder="Search UBBL content..." oninput="searchUBBL(this.value)">
                    <div class="ubbl-filter-chips">
                        <button class="chip active" onclick="filterUBBL('all', this)">All</button>
                        <button class="chip" onclick="filterUBBL('parts', this)">Parts</button>
                        <button class="chip" onclick="filterUBBL('schedules', this)">Schedules</button>
                        <button class="chip" onclick="filterUBBL('2021', this)">2021 Changes</button>
                    </div>
                </div>
                <div id="ubbl-loading" class="loading-msg" style="display:none;"><span class="spinner"></span> Loading UBBL content...</div>
                <div class="ubbl-layout" id="ubbl-container" style="display:none;">
                    <div class="ubbl-toc" id="ubbl-toc"></div>
                    <div class="ubbl-content-area" id="ubbl-content"></div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div class="panel-header">
                    <h2>AI Chat</h2>
                    <span class="cmd">ASK</span>
                </div>
                <div style="padding:0.5rem 1rem; font-size:0.7rem; color:var(--text-muted); border-bottom:1px solid var(--border-subtle); line-height:1.5;">
                    <div>Powered by GPT-5 Mini | Advanced models available for partners (Claude Sonnet &amp; Opus)</div>
                    <div style="margin-top:0.3rem; color:var(--orange); display:flex; align-items:flex-start; gap:0.35rem;">
                        <span style="flex-shrink:0;">&#9888;</span>
                        <span>This AI assistant is for reference only. Always consult qualified professionals for final decisions.</span>
                    </div>
                </div>
                <div id="consent-banner" class="consent-banner">
                    <p><strong>ARAIDEN AI Chat</strong> &mdash; Ask questions about Malaysian building regulations (UBBL, fire by-laws, standards) and get AI-powered answers with citations.</p>
                    <p class="warn">Conversations are stored anonymously to improve the service. Do not share personal or confidential information. This tool is for reference only &mdash; always seek professional consultation for regulatory compliance decisions.</p>
                    <button class="btn" onclick="acceptConsent()">I Understand</button>
                </div>
                <div class="chat-messages" id="chat-messages" style="display:none;"></div>
                <div class="chat-input-area" id="chat-input-area" style="display:none;">
                    <textarea id="chat-input" placeholder="Ask about building regulations..." rows="1" onkeydown="chatKeyDown(event)"></textarea>
                    <button class="btn" id="chat-send-btn" onclick="sendChat()">Send</button>
                </div>
            </div>

            <!-- Documentation Tab -->
            <div id="docs" class="tab-content">
                <div class="panel-header">
                    <h2>Documentation</h2>
                    <span class="cmd">DOCS</span>
                </div>
                <div class="guide-container">

                    <!-- Architecture -->
                    <div class="guide-section">
                        <div class="guide-section-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">1</span>
                            <h3>Architecture Overview</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body">
                            <p>ARAIDEN uses a <strong>Port/Adapter pattern</strong> where all business logic depends on the <code>AutoCADPort</code> protocol, never on COM or platform APIs directly. This enables testing on any platform.</p>

                            <h4>System Layers</h4>
                            <div class="code-block"><span class="comment"># Three entry points share the same operations layer</span>
CLI (Typer)  |  MCP Server (FastMCP)  |  Web API (FastAPI)
                        |
          Operations Layer (pure Python)
     text_ops | layer_ops | geometry_ops | block_ops
     xref_ops | drawing_ops | audit_ops | compliance_ops
                        |
              AutoCADPort (Protocol)
                        |
        ┌───────────────┼───────────────┐
  MockAdapter      AutoCAD COM     BricsCAD COM
  (any platform)   (Windows)       ZWCAD COM</div>

                            <h4>Key Design Principles</h4>
                            <ul>
                                <li><strong>One-way dependencies:</strong> CLI/MCP/Web &rarr; Operations &rarr; Port. Operations never import from entry points.</li>
                                <li><strong>Pydantic models:</strong> All data flows through typed request/result models defined in <code>models.py</code>.</li>
                                <li><strong>Factory pattern:</strong> <code>get_acad_adapter()</code> auto-selects MockAdapter on macOS or the correct COM adapter on Windows.</li>
                                <li><strong>Multi-CAD support:</strong> <code>COMAdapterBase</code> contains all COM logic. AutoCAD, BricsCAD, and ZWCAD are thin subclasses that only set <code>_dispatch_name</code>.</li>
                            </ul>

                            <h4>AutoCADPort Protocol (25 methods)</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Category</th><th>Methods</th></tr></thead>
                                <tbody>
                                    <tr><td><strong>Lifecycle</strong></td><td><code>open_drawing</code>, <code>save_drawing</code>, <code>close_drawing</code></td></tr>
                                    <tr><td><strong>Text</strong></td><td><code>get_text_entities</code>, <code>set_text_value</code></td></tr>
                                    <tr><td><strong>Layers</strong></td><td><code>get_layers</code>, <code>rename_layer</code>, <code>create_layer</code>, <code>set_layer_properties</code>, <code>delete_layer</code></td></tr>
                                    <tr><td><strong>Geometry</strong></td><td><code>get_dimensions</code>, <code>get_polylines</code>, <code>get_entity_coordinates</code>, <code>get_drawing_extents</code></td></tr>
                                    <tr><td><strong>Blocks</strong></td><td><code>get_blocks</code>, <code>get_block_attributes</code>, <code>set_block_attribute</code>, <code>insert_block</code></td></tr>
                                    <tr><td><strong>XREFs</strong></td><td><code>get_xrefs</code>, <code>reload_xref</code>, <code>attach_xref</code>, <code>detach_xref</code></td></tr>
                                    <tr><td><strong>Layouts</strong></td><td><code>get_layouts</code>, <code>get_viewports</code></td></tr>
                                    <tr><td><strong>Utility</strong></td><td><code>plot_layout</code>, <code>purge</code>, <code>audit_drawing</code></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Operations Reference -->
                    <div class="guide-section">
                        <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">2</span>
                            <h3>CAD Operations Reference</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body hidden">
                            <p>All operations follow the same pattern: <code>(adapter, request) &rarr; result</code>. They iterate <code>.dwg</code> files in a folder, open each drawing via the adapter, perform the operation, and return a typed result.</p>

                            <h4>Geometry &amp; Measurement</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Operation</th><th>Module</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>extract_dimensions</code></td><td>geometry_ops</td><td>Extract dimension entities (linear, aligned, angular, radial, diametric) with values, layers, and associated points.</td></tr>
                                    <tr><td><code>extract_areas</code></td><td>geometry_ops</td><td>Extract areas from closed polylines. Filter by layer, min/max area.</td></tr>
                                    <tr><td><code>measure_compliance</code></td><td>geometry_ops</td><td>Auto-compare drawing dimensions against UBBL rule thresholds using layer-to-rule mapping (<code>dimension_mapping.json</code>).</td></tr>
                                </tbody>
                            </table>

                            <h4>Text &amp; Layers</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Operation</th><th>Module</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>batch_find_replace</code></td><td>text_ops</td><td>Find and replace text across drawings with layer and case filters.</td></tr>
                                    <tr><td><code>batch_rename_layer</code></td><td>layer_ops</td><td>Rename a specific layer across all drawings.</td></tr>
                                    <tr><td><code>batch_standardize_layers</code></td><td>layer_ops</td><td>Standardize layer names to AIA, BS1192, or UBBL conventions.</td></tr>
                                    <tr><td><code>audit_drawings</code></td><td>audit_ops</td><td>Audit layer compliance against naming standards.</td></tr>
                                </tbody>
                            </table>

                            <h4>Blocks &amp; Schedules</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Operation</th><th>Module</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>batch_update_title_blocks</code></td><td>block_ops</td><td>Update title block attributes (project no., date, drawn by) across all drawings.</td></tr>
                                    <tr><td><code>extract_schedule</code></td><td>block_ops</td><td>Extract door/window/room schedules from block attributes.</td></tr>
                                </tbody>
                            </table>

                            <h4>XREFs &amp; Utilities</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Operation</th><th>Module</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>manage_xrefs</code></td><td>xref_ops</td><td>List, reload, attach, or detach external references.</td></tr>
                                    <tr><td><code>batch_purge</code></td><td>drawing_ops</td><td>Purge unused items and optionally audit for errors.</td></tr>
                                    <tr><td><code>batch_plot</code></td><td>drawing_ops</td><td>Batch plot layouts to PDF or DWF.</td></tr>
                                    <tr><td><code>drawing_search</code></td><td>drawing_ops</td><td>Search text, attributes, and layers across drawings.</td></tr>
                                    <tr><td><code>get_drawing_info</code></td><td>drawing_ops</td><td>Comprehensive info summary per file (layers, blocks, dims, extents).</td></tr>
                                </tbody>
                            </table>

                            <h4>Compliance</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Operation</th><th>Module</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>check_compliance</code></td><td>compliance_ops</td><td>Check applicable rules from rule set JSON files.</td></tr>
                                    <tr><td><code>query_knowledge_base</code></td><td>knowledge/loader</td><td>Search the Markdown knowledge base by keywords.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- CLI Reference -->
                    <div class="guide-section">
                        <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">3</span>
                            <h3>CLI Command Reference</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body hidden">
                            <p>All commands use <code>autocad-cmd &lt;command&gt;</code>. Add <code>--mock</code> for mock adapter on macOS/Linux.</p>

                            <table class="endpoint-table">
                                <thead><tr><th>Command</th><th>Description</th><th>Key Options</th></tr></thead>
                                <tbody>
                                    <tr><td><code>change-text</code></td><td>Find &amp; replace text</td><td><code>--find</code>, <code>--replace</code>, <code>--layers</code></td></tr>
                                    <tr><td><code>rename-layer</code></td><td>Rename a layer</td><td><code>--old</code>, <code>--new</code></td></tr>
                                    <tr><td><code>standardize</code></td><td>Standardize layer names</td><td><code>--standard</code> (AIA/BS1192/UBBL)</td></tr>
                                    <tr><td><code>audit</code></td><td>Audit layer compliance</td><td><code>--standard</code></td></tr>
                                    <tr><td><code>extract-dims</code></td><td>Extract dimensions</td><td><code>--layers</code>, <code>--types</code></td></tr>
                                    <tr><td><code>extract-areas</code></td><td>Extract polyline areas</td><td><code>--min-area</code>, <code>--max-area</code></td></tr>
                                    <tr><td><code>check-drawing</code></td><td>Measure vs. UBBL rules</td><td><code>--rules</code>, <code>--building-type</code></td></tr>
                                    <tr><td><code>update-titleblock</code></td><td>Update title blocks</td><td><code>--updates</code> (TAG=VALUE,...)</td></tr>
                                    <tr><td><code>extract-schedule</code></td><td>Extract block schedules</td><td><code>--block-name</code>, <code>--tags</code></td></tr>
                                    <tr><td><code>manage-xrefs</code></td><td>XREF management</td><td><code>--action</code> (list/reload/attach/detach)</td></tr>
                                    <tr><td><code>search-drawings</code></td><td>Search across drawings</td><td><code>--text</code>, <code>--search-in</code></td></tr>
                                    <tr><td><code>batch-plot</code></td><td>Plot to PDF/DWF</td><td><code>--output-dir</code>, <code>--format</code></td></tr>
                                    <tr><td><code>purge</code></td><td>Purge unused items</td><td><code>--no-audit</code>, <code>--no-backup</code></td></tr>
                                    <tr><td><code>drawing-info</code></td><td>Drawing info summary</td><td>&mdash;</td></tr>
                                    <tr><td><code>query</code></td><td>Search knowledge base</td><td>&mdash;</td></tr>
                                    <tr><td><code>check-compliance</code></td><td>Check compliance rules</td><td><code>--rules</code>, <code>--building-type</code></td></tr>
                                    <tr><td><code>list-rules</code></td><td>List rule sets</td><td>&mdash;</td></tr>
                                    <tr><td><code>serve</code></td><td>Start web server</td><td><code>--port</code></td></tr>
                                    <tr><td><code>version</code></td><td>Show version</td><td>&mdash;</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- API Reference -->
                    <div class="guide-section">
                        <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">4</span>
                            <h3>Web API Reference</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body hidden">
                            <table class="endpoint-table">
                                <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><span class="method method-get">GET</span></td><td><code>/</code></td><td>Web UI (this page)</td></tr>
                                    <tr><td><span class="method method-get">GET</span></td><td><code>/api/health</code></td><td>Health check &mdash; includes <code>chat_enabled</code> flag</td></tr>
                                    <tr><td><span class="method method-post">POST</span></td><td><code>/api/query</code></td><td>Search knowledge base. Body: <code>{"question": "..."}</code></td></tr>
                                    <tr><td><span class="method method-get">GET</span></td><td><code>/api/rules</code></td><td>List all compliance rule sets</td></tr>
                                    <tr><td><span class="method method-get">GET</span></td><td><code>/api/rules/{name}</code></td><td>Get rules in a specific set</td></tr>
                                    <tr><td><span class="method method-post">POST</span></td><td><code>/api/compliance/check</code></td><td>Run compliance check. Body: <code>ComplianceCheckRequest</code></td></tr>
                                    <tr><td><span class="method method-post">POST</span></td><td><code>/api/chat/session</code></td><td>Create chat session with consent</td></tr>
                                    <tr><td><span class="method method-post">POST</span></td><td><code>/api/chat</code></td><td>Send message &rarr; SSE streamed response</td></tr>
                                    <tr><td><span class="method method-post">POST</span></td><td><code>/api/feedback</code></td><td>Submit thumbs up/down feedback on AI response</td></tr>
                                </tbody>
                            </table>

                            <h4>Example: Search Knowledge Base</h4>
                            <div class="code-block">curl -X POST http://localhost:8000/api/query \
  -H "Content-Type: application/json" \
  -d '{"question": "minimum corridor width for commercial building"}'</div>

                            <h4>Example: Compliance Check</h4>
                            <div class="code-block">curl -X POST http://localhost:8000/api/compliance/check \
  -H "Content-Type: application/json" \
  -d '{
    "rule_sets": ["ubbl-spatial", "ubbl-fire"],
    "building_type": "residential",
    "categories": ["escape"]
  }'</div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="guide-section">
                        <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">5</span>
                            <h3>Configuration &amp; Environment Variables</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body hidden">
                            <p>All settings use the <code>ACAD_CMD_</code> prefix and are managed by pydantic-settings.</p>

                            <h4>Core Settings</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Variable</th><th>Default</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>ACAD_CMD_LOG_LEVEL</code></td><td><code>INFO</code></td><td>Logging level</td></tr>
                                    <tr><td><code>ACAD_CMD_CAD_ENGINE</code></td><td><code>auto</code></td><td>CAD engine: <code>auto</code>, <code>autocad</code>, <code>bricscad</code>, <code>zwcad</code>, <code>mock</code></td></tr>
                                </tbody>
                            </table>

                            <h4>AI Chat Settings</h4>
                            <table class="endpoint-table">
                                <thead><tr><th>Variable</th><th>Default</th><th>Description</th></tr></thead>
                                <tbody>
                                    <tr><td><code>ACAD_CMD_CHAT_ENABLED</code></td><td><code>false</code></td><td>Enable AI Chat feature</td></tr>
                                    <tr><td><code>ACAD_CMD_OPENAI_API_KEY</code></td><td>&mdash;</td><td>OpenAI API key</td></tr>
                                    <tr><td><code>ACAD_CMD_OPENAI_MODEL</code></td><td><code>gpt-5-mini</code></td><td>Chat completion model</td></tr>
                                    <tr><td><code>ACAD_CMD_OPENAI_EMBEDDING_MODEL</code></td><td><code>text-embedding-3-small</code></td><td>Embedding model</td></tr>
                                    <tr><td><code>ACAD_CMD_SUPABASE_URL</code></td><td>&mdash;</td><td>Supabase project URL</td></tr>
                                    <tr><td><code>ACAD_CMD_SUPABASE_KEY</code></td><td>&mdash;</td><td>Supabase publishable/anon key</td></tr>
                                    <tr><td><code>ACAD_CMD_CHAT_MAX_HISTORY</code></td><td><code>10</code></td><td>Max conversation turns sent to LLM</td></tr>
                                    <tr><td><code>ACAD_CMD_CHAT_MAX_CONTEXT_CHUNKS</code></td><td><code>6</code></td><td>Max RAG chunks retrieved per query</td></tr>
                                    <tr><td><code>ACAD_CMD_CHAT_SIMILARITY_THRESHOLD</code></td><td><code>0.4</code></td><td>Minimum cosine similarity for retrieval</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Project Structure -->
                    <div class="guide-section">
                        <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                            <span class="step-num">6</span>
                            <h3>Project Structure</h3>
                            <span class="chevron">&#9660;</span>
                        </div>
                        <div class="guide-body hidden">
                            <div class="code-block">src/autocad_batch_commander/
  acad/                     <span class="comment"># Port/Adapter layer</span>
    port.py                 <span class="comment"># AutoCADPort protocol (25 methods)</span>
    mock_adapter.py         <span class="comment"># Mock adapter for testing</span>
    com_base.py             <span class="comment"># Shared COM base class</span>
    real_adapter.py         <span class="comment"># AutoCAD COM adapter</span>
    bricscad_adapter.py     <span class="comment"># BricsCAD COM adapter</span>
    zwcad_adapter.py        <span class="comment"># ZWCAD COM adapter</span>
    factory.py              <span class="comment"># Adapter factory + sample data</span>
  operations/               <span class="comment"># Business logic</span>
    text_ops.py             <span class="comment"># Text find/replace</span>
    layer_ops.py            <span class="comment"># Layer rename/standardize</span>
    audit_ops.py            <span class="comment"># Layer compliance audit</span>
    compliance_ops.py       <span class="comment"># Rule-based compliance checks</span>
    geometry_ops.py         <span class="comment"># Dimensions, areas, measurement</span>
    block_ops.py            <span class="comment"># Title blocks, schedules</span>
    xref_ops.py             <span class="comment"># External reference management</span>
    drawing_ops.py          <span class="comment"># Purge, plot, search, info</span>
  cli/                      <span class="comment"># Typer CLI entry point</span>
    app.py                  <span class="comment"># ~20 CLI commands</span>
    formatters.py           <span class="comment"># Rich table output formatters</span>
  mcp_server/               <span class="comment"># FastMCP server</span>
    server.py               <span class="comment"># 19 MCP tools</span>
    nl_router.py            <span class="comment"># Natural language intent router</span>
  web/                      <span class="comment"># FastAPI web server</span>
    api.py                  <span class="comment"># REST API endpoints</span>
    templates/index.html    <span class="comment"># Single-page web UI</span>
  chat/                     <span class="comment"># AI Chat RAG pipeline</span>
    rag.py                  <span class="comment"># RAG orchestration</span>
    embeddings.py           <span class="comment"># pgvector search</span>
    prompts.py              <span class="comment"># System prompt template</span>
  knowledge/                <span class="comment"># Knowledge base loader</span>
    loader.py               <span class="comment"># Keyword-based file retrieval</span>
  models.py                 <span class="comment"># All Pydantic v2 models</span>
  config.py                 <span class="comment"># pydantic-settings config</span>

knowledge/qa/               <span class="comment"># 49 Markdown knowledge files</span>
standards/                  <span class="comment"># Layer naming standards</span>
  rules/                    <span class="comment"># 8 compliance rule sets (JSON)</span>
  dimension_mapping.json    <span class="comment"># Layer &rarr; rule parameter mapping</span></div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Setup Guide Tab -->
            <div id="setup" class="tab-content active">
                <div class="panel-header">
                    <h2>Setup Guide</h2>
                    <span class="cmd">INSTALL</span>
                    <div style="margin-left:auto; display:flex; gap:0.4rem; align-items:center;">
                        <a href="https://github.com/zemang86/cad-ai" target="_blank" class="guide-action-btn" title="View on GitHub">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                        </a>
                        <button class="guide-action-btn" onclick="downloadSetupGuide()" title="Download as Markdown">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            <span>.md</span>
                        </button>
                        <button class="guide-action-btn" onclick="copySetupGuide(this)" title="Copy Markdown for AI">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                            <span>Copy for AI</span>
                        </button>
                    </div>
                </div>

                <!-- Step 1: Installation -->
                <div class="guide-section">
                    <div class="guide-section-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">1</span>
                        <h3>Installation</h3>
                        <span class="badge badge-all">All Platforms</span>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body">
                        <p>Clone the repository and set up a Python virtual environment:</p>
                        <div class="code-block"><span class="comment"># Clone the repo</span>
git clone https://github.com/zemang86/cad-ai.git
cd cad-ai

<span class="comment"># Create virtual environment</span>
python -m venv .venv

<span class="comment"># Activate (macOS/Linux)</span>
source .venv/bin/activate

<span class="comment"># Activate (Windows)</span>
.venv\Scripts\activate</div>

                        <h4>Install Options</h4>
                        <div class="code-block"><span class="comment"># Basic install (CLI + knowledge base)</span>
pip install -e .

<span class="comment"># With web server support</span>
pip install -e ".[web]"

<span class="comment"># With web + AI chat (OpenAI + Supabase)</span>
pip install -e ".[web,ai]"

<span class="comment"># With Windows AutoCAD support (Windows only)</span>
pip install -e ".[windows]"

<span class="comment"># Development (includes testing + linting)</span>
pip install -e ".[dev]"</div>

                        <p>After installation, the <code>autocad-cmd</code> CLI is available in your path.</p>
                    </div>
                </div>

                <!-- Step 2: CLI Usage -->
                <div class="guide-section">
                    <div class="guide-section-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">2</span>
                        <h3>CLI Usage</h3>
                        <span class="badge badge-all">All Platforms</span>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body">
                        <h4>Knowledge Base Queries</h4>
                        <div class="code-block"><span class="comment"># Search Malaysian building regulations</span>
autocad-cmd query "minimum corridor width"
autocad-cmd query "fire escape requirements"
autocad-cmd query "swimming pool depth"
autocad-cmd query "purpose group classification"</div>

                        <h4>Compliance Checking</h4>
                        <div class="code-block"><span class="comment"># Check all rules for a building type</span>
autocad-cmd check-compliance-cmd --rules ubbl-spatial --building-type residential --mock

<span class="comment"># List available rule sets</span>
autocad-cmd list-rules</div>

                        <h4>CAD Drawing Operations <span class="badge badge-win">Windows</span></h4>
                        <div class="code-block"><span class="comment"># Find and replace text in DWG files</span>
autocad-cmd change-text --folder ./plans --find "OLD" --replace "NEW" --mock

<span class="comment"># Rename layers to match standards</span>
autocad-cmd rename-layer --folder ./plans --standard aia --mock

<span class="comment"># Audit drawings against standards</span>
autocad-cmd audit --folder ./plans --standard aia --mock</div>

                        <h4>Geometry &amp; Measurement</h4>
                        <div class="code-block"><span class="comment"># Extract dimensions from drawings</span>
autocad-cmd extract-dims --folder ./plans --mock

<span class="comment"># Extract areas from closed polylines</span>
autocad-cmd extract-areas --folder ./plans --mock

<span class="comment"># Check drawing dimensions against UBBL rules</span>
autocad-cmd check-drawing --folder ./plans --rules ubbl-spatial --mock</div>

                        <h4>Blocks &amp; Schedules</h4>
                        <div class="code-block"><span class="comment"># Update title blocks across all drawings</span>
autocad-cmd update-titleblock --folder ./plans --updates "DATE=2024-06-01,DRAWN_BY=ZA" --mock

<span class="comment"># Extract door/window schedules from block attributes</span>
autocad-cmd extract-schedule --folder ./plans --block-name DOOR_SINGLE --mock</div>

                        <h4>XREFs, Search &amp; Utilities</h4>
                        <div class="code-block"><span class="comment"># List external references</span>
autocad-cmd manage-xrefs-cmd --folder ./plans --action list --mock

<span class="comment"># Search text across all drawings</span>
autocad-cmd search-drawings --folder ./plans --text "TIMBER" --mock

<span class="comment"># Batch plot to PDF</span>
autocad-cmd batch-plot-cmd --folder ./plans --mock

<span class="comment"># Purge unused items</span>
autocad-cmd purge --folder ./plans --no-backup --mock

<span class="comment"># Drawing info summary</span>
autocad-cmd drawing-info --folder ./plans --mock</div>

                        <p><strong>Note:</strong> Use <code>--mock</code> on macOS/Linux for testing. On Windows with AutoCAD/BricsCAD/ZWCAD running, omit <code>--mock</code> to operate on real DWG files.</p>

                        <h4>Web Server</h4>
                        <div class="code-block"><span class="comment"># Start the web UI (this page)</span>
autocad-cmd serve
autocad-cmd serve --port 3000</div>
                    </div>
                </div>

                <!-- Step 3: MCP Server -->
                <div class="guide-section">
                    <div class="guide-section-header" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">3</span>
                        <h3>MCP Server for Claude Desktop</h3>
                        <span class="badge badge-all">All Platforms</span>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body">
                        <p>The MCP (Model Context Protocol) server lets Claude Desktop access the CAD knowledge base and compliance tools directly. Claude can then answer questions about Malaysian building regulations and check compliance rules.</p>

                        <h4>Start the MCP Server</h4>
                        <div class="code-block"><span class="comment"># macOS/Linux</span>
.venv/bin/python -m autocad_batch_commander.mcp_server.server

<span class="comment"># Windows</span>
.venv\Scripts\python -m autocad_batch_commander.mcp_server.server</div>

                        <h4>Configure Claude Desktop</h4>
                        <p>Add the following to your Claude Desktop config file:</p>
                        <ul>
                            <li><strong>macOS:</strong> <code>~/Library/Application Support/Claude/claude_desktop_config.json</code></li>
                            <li><strong>Windows:</strong> <code>%APPDATA%\Claude\claude_desktop_config.json</code></li>
                        </ul>
                        <div class="config-json">{
  <span class="key">"mcpServers"</span>: {
    <span class="key">"cad-commander"</span>: {
      <span class="key">"command"</span>: <span class="string">"/path/to/cad-ai/.venv/bin/python"</span>,
      <span class="key">"args"</span>: [
        <span class="string">"-m"</span>,
        <span class="string">"autocad_batch_commander.mcp_server.server"</span>
      ],
      <span class="key">"env"</span>: {
        <span class="key">"PYTHONPATH"</span>: <span class="string">"/path/to/cad-ai/src"</span>
      }
    }
  }
}</div>
                        <p>Replace <code>/path/to/cad-ai</code> with the actual path to your installation.</p>

                        <h4>Available MCP Tools (19 tools)</h4>

                        <p style="margin-bottom:0.5rem;"><strong>Knowledge &amp; Compliance</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>query_regulations</code></td><td>Search the knowledge base for Malaysian building regulations</td></tr>
                                <tr><td><code>check_compliance_tool</code></td><td>Run compliance checks against rule sets (spatial, fire, energy, accessibility)</td></tr>
                                <tr><td><code>list_available_rules</code></td><td>List all available compliance rule sets</td></tr>
                            </tbody>
                        </table>

                        <p style="margin-bottom:0.5rem;"><strong>Text &amp; Layers</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>batch_change_text</code></td><td>Find and replace text across DWG files</td></tr>
                                <tr><td><code>batch_rename_layer_tool</code></td><td>Rename layers to match standards</td></tr>
                                <tr><td><code>standardize_layers_tool</code></td><td>Batch standardize layer names (AIA, BS1192, UBBL)</td></tr>
                                <tr><td><code>audit_drawings_tool</code></td><td>Audit drawings against layer standards</td></tr>
                            </tbody>
                        </table>

                        <p style="margin-bottom:0.5rem;"><strong>Geometry &amp; Measurement</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>extract_dimensions_tool</code></td><td>Extract all dimension entities with values, types, layers</td></tr>
                                <tr><td><code>extract_areas_tool</code></td><td>Extract areas from closed polylines with min/max filters</td></tr>
                                <tr><td><code>measure_compliance_tool</code></td><td>Auto-measure dimensions against UBBL rule thresholds</td></tr>
                            </tbody>
                        </table>

                        <p style="margin-bottom:0.5rem;"><strong>Blocks &amp; Schedules</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>update_title_blocks_tool</code></td><td>Update title block attributes (date, drawn by, project no.) across DWGs</td></tr>
                                <tr><td><code>extract_schedule_tool</code></td><td>Extract door/window/room schedules from block attributes</td></tr>
                            </tbody>
                        </table>

                        <p style="margin-bottom:0.5rem;"><strong>XREFs, Search &amp; Utilities</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>manage_xrefs_tool</code></td><td>List, reload, attach, or detach external references</td></tr>
                                <tr><td><code>search_drawings_tool</code></td><td>Search text, attributes, and layers across project drawings</td></tr>
                                <tr><td><code>batch_plot_tool</code></td><td>Batch plot layouts to PDF or DWF</td></tr>
                                <tr><td><code>batch_purge_tool</code></td><td>Purge unused items and audit drawings</td></tr>
                                <tr><td><code>get_drawing_info_tool</code></td><td>Comprehensive drawing info summary per file</td></tr>
                            </tbody>
                        </table>

                        <p style="margin-bottom:0.5rem;"><strong>Natural Language</strong></p>
                        <table class="endpoint-table">
                            <thead><tr><th>Tool</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><code>ask_araiden</code></td><td>Natural language interface &mdash; ask questions or give instructions in plain English</td></tr>
                            </tbody>
                        </table>

                        <h4>Example Prompts for Claude</h4>
                        <p>Once connected, you can ask Claude things like:</p>
                        <ul>
                            <li>"What is the minimum corridor width for a commercial building under UBBL?"</li>
                            <li>"Check if a 25-storey residential building meets fire safety requirements"</li>
                            <li>"What purpose group does a hotel fall under?"</li>
                            <li>"Extract all dimensions from my floor plan drawings"</li>
                            <li>"Check if the corridor widths in my drawings comply with UBBL"</li>
                            <li>"Update the title block date to 2025-01-15 across all drawings"</li>
                            <li>"Generate a door schedule from the attributed blocks"</li>
                            <li>"List all external references in the project"</li>
                        </ul>
                    </div>
                </div>

                <!-- Step 4: Windows + CAD Setup -->
                <div class="guide-section">
                    <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">4</span>
                        <h3>Windows + CAD Application Setup</h3>
                        <span class="badge badge-win">Windows Only</span>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body hidden">
                        <p>For full CAD drawing operations, you need Windows with a supported CAD application.</p>

                        <h4>Supported CAD Applications</h4>
                        <table class="endpoint-table">
                            <thead><tr><th>Application</th><th>COM Dispatch Name</th><th>Engine Flag</th></tr></thead>
                            <tbody>
                                <tr><td><strong>AutoCAD</strong> 2020+</td><td><code>AutoCAD.Application</code></td><td><code>autocad</code></td></tr>
                                <tr><td><strong>BricsCAD</strong></td><td><code>BricscadApp.AcadApplication</code></td><td><code>bricscad</code></td></tr>
                                <tr><td><strong>ZWCAD</strong></td><td><code>ZWCAD.Application</code></td><td><code>zwcad</code></td></tr>
                            </tbody>
                        </table>

                        <h4>Prerequisites</h4>
                        <ul>
                            <li>One of the supported CAD applications installed and <strong>running</strong></li>
                            <li>Python 3.10+ with pywin32</li>
                        </ul>

                        <h4>Install with Windows Extras</h4>
                        <div class="code-block">pip install -e ".[windows]"</div>

                        <h4>CAD Configuration</h4>
                        <ol>
                            <li>Open your CAD application and type <code>SECURELOAD</code> at the command prompt</li>
                            <li>Set the value to <strong>0</strong> (allows COM automation)</li>
                            <li>Keep the application running &mdash; the tool connects via COM to the live instance</li>
                        </ol>

                        <h4>CAD Engine Selection</h4>
                        <p>By default, ARAIDEN auto-detects which CAD application is running. You can also set it explicitly:</p>
                        <div class="code-block"><span class="comment"># Auto-detect (default)</span>
export ACAD_CMD_CAD_ENGINE=auto

<span class="comment"># Force specific CAD engine</span>
export ACAD_CMD_CAD_ENGINE=autocad
export ACAD_CMD_CAD_ENGINE=bricscad
export ACAD_CMD_CAD_ENGINE=zwcad</div>

                        <h4>Usage on Windows</h4>
                        <div class="code-block"><span class="comment"># No --mock needed on Windows with CAD running</span>
autocad-cmd change-text --folder "C:\Projects\Plans" --find "DRAFT" --replace "FINAL"
autocad-cmd extract-dims --folder "C:\Projects\Plans"
autocad-cmd check-drawing --folder "C:\Projects\Plans" --rules ubbl-spatial
autocad-cmd drawing-info --folder "C:\Projects\Plans"</div>

                        <p>The tool auto-detects Windows and the running CAD application. All adapters share the same COM base class, so all operations work identically across AutoCAD, BricsCAD, and ZWCAD. Backups are saved to a <code>.backups/</code> subdirectory next to each DWG file.</p>
                    </div>
                </div>

                <!-- Step 5: Web API -->
                <div class="guide-section">
                    <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">5</span>
                        <h3>Web API &amp; Docker Deployment</h3>
                        <span class="badge badge-all">All Platforms</span>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body hidden">
                        <h4>API Endpoints</h4>
                        <table class="endpoint-table">
                            <thead><tr><th>Method</th><th>Endpoint</th><th>Description</th></tr></thead>
                            <tbody>
                                <tr><td><span class="method method-get">GET</span></td><td><code>/</code></td><td>This web UI</td></tr>
                                <tr><td><span class="method method-get">GET</span></td><td><code>/api/health</code></td><td>Health check</td></tr>
                                <tr><td><span class="method method-post">POST</span></td><td><code>/api/query</code></td><td>Search knowledge base</td></tr>
                                <tr><td><span class="method method-get">GET</span></td><td><code>/api/rules</code></td><td>List all rule sets</td></tr>
                                <tr><td><span class="method method-get">GET</span></td><td><code>/api/rules/{name}</code></td><td>Get rules in a set</td></tr>
                                <tr><td><span class="method method-post">POST</span></td><td><code>/api/compliance/check</code></td><td>Run compliance check</td></tr>
                                <tr><td><span class="method method-post">POST</span></td><td><code>/api/chat/session</code></td><td>Create chat session (AI Chat)</td></tr>
                                <tr><td><span class="method method-post">POST</span></td><td><code>/api/chat</code></td><td>Send message, SSE stream (AI Chat)</td></tr>
                                <tr><td><span class="method method-post">POST</span></td><td><code>/api/feedback</code></td><td>Submit thumbs up/down (AI Chat)</td></tr>
                            </tbody>
                        </table>

                        <h4>API Examples</h4>
                        <div class="code-block"><span class="comment"># Search knowledge base</span>
curl -X POST http://localhost:8000/api/query \
  -H "Content-Type: application/json" \
  -d '{"question": "minimum corridor width"}'

<span class="comment"># List rule sets</span>
curl http://localhost:8000/api/rules

<span class="comment"># Run compliance check</span>
curl -X POST http://localhost:8000/api/compliance/check \
  -H "Content-Type: application/json" \
  -d '{"rule_sets": ["ubbl-spatial"], "building_type": "residential"}'</div>

                        <h4>Docker Deployment</h4>
                        <div class="code-block"><span class="comment"># Build and run</span>
docker build -t cad-ai .
docker run -p 8000:8000 cad-ai

<span class="comment"># Or with Docker Compose</span>
docker compose up</div>
                    </div>
                </div>

                <!-- Step 6: Knowledge Base -->
                <div class="guide-section">
                    <div class="guide-section-header collapsed" onclick="this.classList.toggle('collapsed');this.nextElementSibling.classList.toggle('hidden')">
                        <span class="step-num">6</span>
                        <h3>Knowledge Base Coverage</h3>
                        <span class="chevron">&#9660;</span>
                    </div>
                    <div class="guide-body hidden">
                        <p>The knowledge base covers Malaysian building regulations from official gazette sources:</p>

                        <h4>UBBL 1984 (with 2021 Amendment)</h4>
                        <ul>
                            <li><strong>Part I</strong> &mdash; Preliminary (definitions, interpretation)</li>
                            <li><strong>Part IA</strong> &mdash; Demolition of Buildings</li>
                            <li><strong>Part II</strong> &mdash; Plan Submission (By-laws 3&ndash;29)</li>
                            <li><strong>Part III</strong> &mdash; Space, Light &amp; Ventilation (room sizes, corridors, ceiling heights)</li>
                            <li><strong>Part IV</strong> &mdash; Temporary Works</li>
                            <li><strong>Part V</strong> &mdash; Structural Requirements (loads, foundations)</li>
                            <li><strong>Part VI</strong> &mdash; Constructional Requirements (staircases, swimming pools, party walls, lifts)</li>
                            <li><strong>Part VII</strong> &mdash; Fire Safety (compartmentation, escape routes, fire doors)</li>
                            <li><strong>Part VIII</strong> &mdash; Fire Alarm &amp; Extinguishment (smoke control, atriums, risers, emergency power)</li>
                            <li><strong>Part IX</strong> &mdash; Miscellaneous</li>
                            <li><strong>Schedules 5, 7, 9, 10, 11</strong> &mdash; Purpose groups, travel distances, fire resistance periods, alarm requirements, staircase landings</li>
                        </ul>

                        <h4>Other Sources</h4>
                        <ul>
                            <li><strong>Fire By-Laws</strong> &mdash; Bomba requirements, fire certificates, fire fighting systems</li>
                            <li><strong>Legislation</strong> &mdash; Act 133 (SDBA), Act 172 (Planning), Strata Management, Housing Development</li>
                            <li><strong>Standards</strong> &mdash; MS 1525 (Energy), MS 2680 (Residential Energy), MS 1184 (Accessibility), MS Fire Standards</li>
                            <li><strong>Agencies</strong> &mdash; JKR, CIDB, DOE requirements</li>
                            <li><strong>Green Building</strong> &mdash; GBI certification, solar/renewable energy</li>
                            <li><strong>Building Types</strong> &mdash; High-rise, industrial, healthcare, educational</li>
                        </ul>

                        <h4>Compliance Rule Sets</h4>
                        <p>Machine-readable rules with numeric thresholds for automated checking:</p>
                        <ul>
                            <li><code>ubbl-spatial</code> &mdash; 17 rules (rooms, corridors, stairs, ventilation)</li>
                            <li><code>ubbl-fire</code> &mdash; 13 rules (fire resistance, compartmentation, escape)</li>
                            <li><code>ubbl-fire-expanded</code> &mdash; 25 rules (Part VIII thresholds, atriums, smoke control)</li>
                            <li><code>ubbl-constructional</code> &mdash; 16 rules (staircases, swimming pools, party walls)</li>
                            <li><code>bomba-fire-systems</code> &mdash; 12 rules (hose reel, hydrant, dry riser, fire doors)</li>
                            <li><code>accessibility</code> &mdash; 12 rules (ramps, handrails, toilets, lifts)</li>
                            <li><code>energy-efficiency</code> &mdash; 8 rules (OTTV, RTTV, roof U-values, BEI)</li>
                            <li><code>environmental</code> &mdash; 10 rules (EIA, effluent, noise)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Command line / status bar -->
    <div class="cmdline">
        <span>ARAIDEN v0.1.0</span>
        <span class="coord" id="cmd-status">Ready</span>
        <span style="margin-left:auto;">UBBL 2021 | Fire By-Laws | MS Standards</span>
    </div>

    <script>
        // ── Theme ────────────────────────────────────────
        function getTheme() {
            return localStorage.getItem('cad-theme') || 'dark';
        }
        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-icon-dark').style.display = t === 'dark' ? 'none' : 'block';
            document.getElementById('theme-icon-light').style.display = t === 'dark' ? 'block' : 'none';
        }
        function toggleTheme() {
            const next = getTheme() === 'dark' ? 'light' : 'dark';
            localStorage.setItem('cad-theme', next);
            applyTheme(next);
        }
        applyTheme(getTheme());

        // ── Tab switching ────────────────────────────────
        function switchTab(tabId, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.mobile-nav .chip').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            if (el) el.classList.add('active');

            // Sync sidebar + mobile
            document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(e => e.classList.add('active'));
        }

        // Enter key for search
        document.getElementById('query-input').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });

        // ── Load rule sets ───────────────────────────────
        async function loadRuleSets() {
            try {
                const res = await fetch('/api/rules');
                const data = await res.json();
                const select = document.getElementById('rule-select');
                const list = document.getElementById('rule-set-list');
                document.getElementById('rule-count-text').textContent = data.rule_sets.length + ' available';

                data.rule_sets.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);

                    const btn = document.createElement('button');
                    btn.className = 'chip';
                    btn.textContent = name;
                    btn.onclick = () => browseRuleSet(name, btn);
                    list.appendChild(btn);
                });
            } catch (e) {
                console.error('Failed to load rule sets:', e);
            }
        }
        loadRuleSets();

        // ── Status helper ────────────────────────────────
        function setStatus(msg) {
            document.getElementById('cmd-status').textContent = msg;
        }

        // ── Search ───────────────────────────────────────
        async function doSearch() {
            const q = document.getElementById('query-input').value.trim();
            if (!q) return;
            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="loading-msg"><span class="spinner"></span> Searching knowledge base...</div>';
            setStatus('Searching: ' + q);
            try {
                const res = await fetch('/api/query', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: q}),
                });
                const data = await res.json();
                if (data.files_loaded === 0) {
                    container.innerHTML = '<p class="empty">No matching regulations found.</p>';
                    setStatus('No results');
                    return;
                }
                let html = '<div class="results"><div class="results-header"><span>Results</span><span class="count">' + data.files_loaded + ' file(s)</span></div>';
                for (const [file, content] of Object.entries(data.results)) {
                    html += '<div class="file-section">';
                    html += '<div class="file-header" onclick="this.classList.toggle(\'collapsed\');this.nextElementSibling.classList.toggle(\'hidden\')"><span class="chevron">&#9660;</span> ' + file + '</div>';
                    html += '<div class="file-body"><div class="md-content">' + marked.parse(content) + '</div></div>';
                    html += '</div>';
                }
                html += '</div>';
                container.innerHTML = html;
                setStatus(data.files_loaded + ' result(s) for "' + q + '"');
            } catch (e) {
                container.innerHTML = '<div class="card" style="color:var(--red);">Error: ' + e.message + '</div>';
                setStatus('Error');
            }
        }

        // ── Compliance ───────────────────────────────────
        async function doCompliance() {
            const select = document.getElementById('rule-select');
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            if (selected.length === 0) {
                alert('Select at least one rule set.');
                return;
            }
            const bt = document.getElementById('building-type').value.trim() || null;
            const container = document.getElementById('compliance-results');
            container.innerHTML = '<div class="loading-msg"><span class="spinner"></span> Running compliance check...</div>';
            setStatus('Checking: ' + selected.join(', '));
            try {
                const res = await fetch('/api/compliance/check', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({rule_sets: selected, building_type: bt}),
                });
                const data = await res.json();
                let html = '<div class="results"><div class="results-header"><span>Findings</span><span class="count">' + data.total_rules + ' rules</span><span class="count">' + data.rule_sets_loaded + ' set(s)</span></div>';
                if (data.findings.length === 0) {
                    html += '<p class="empty">No applicable rules found for the selected filters.</p>';
                } else {
                    data.findings.forEach(f => {
                        html += '<div class="finding severity-' + f.severity + '">';
                        html += '<div class="finding-header"><span class="rule-id">' + f.rule_id + '</span><span class="by-law">' + f.by_law + '</span></div>';
                        html += '<div class="desc">' + f.description + '</div>';
                        if (f.threshold != null) {
                            html += '<div class="threshold">' + f.check_type + ': ' + f.parameter + ' ' + f.threshold + ' ' + f.unit + '</div>';
                        }
                        if (f.tags && f.tags.length) {
                            html += '<div class="tags">' + f.tags.map(t => '<span class="tag">' + t + '</span>').join('') + '</div>';
                        }
                        html += '</div>';
                    });
                }
                html += '</div>';
                container.innerHTML = html;
                setStatus(data.total_rules + ' rules checked');
            } catch (e) {
                container.innerHTML = '<div class="card" style="color:var(--red);">Error: ' + e.message + '</div>';
                setStatus('Error');
            }
        }

        // ── UBBL Browser ────────────────────────────────
        let ubblData = null;
        let ubblLoaded = false;
        let ubblActiveFilter = 'all';
        let ubblSearchQuery = '';

        // Hook into tab switching to lazy-load UBBL
        const _origSwitchTab = switchTab;
        switchTab = function(tabId, el) {
            _origSwitchTab(tabId, el);
            if (tabId === 'ubbl' && !ubblLoaded) {
                initUBBL();
            }
        };

        async function initUBBL() {
            ubblLoaded = true;
            document.getElementById('ubbl-loading').style.display = 'block';
            try {
                const res = await fetch('/api/ubbl');
                ubblData = await res.json();
                renderUBBLTOC(ubblData);
                renderUBBLContent(ubblData);
                document.getElementById('ubbl-container').style.display = 'grid';
                setupUBBLScrollSpy();
                setStatus(ubblData.length + ' UBBL sections loaded');
            } catch (e) {
                document.getElementById('ubbl-content').innerHTML = '<div class="card" style="color:var(--red);">Error loading UBBL content: ' + e.message + '</div>';
            }
            document.getElementById('ubbl-loading').style.display = 'none';
        }

        function ubblBadgeHTML(section) {
            if (section.is_new_2021) return '<span class="new-badge">NEW</span>';
            if (section.has_2021_changes) return '<span class="amendment-badge">2021</span>';
            return '';
        }

        function renderUBBLTOC(data) {
            const toc = document.getElementById('ubbl-toc');
            const groups = { amendment: [], parts: [], schedules: [], specialized: [] };
            const groupLabels = { amendment: '2021 Amendment', parts: 'Parts', schedules: 'Schedules', specialized: 'Specialized' };
            data.forEach(s => {
                const g = groups[s.category] || groups.specialized;
                g.push(s);
            });
            let html = '';
            for (const [key, items] of Object.entries(groups)) {
                if (items.length === 0) continue;
                html += '<div class="ubbl-toc-header" data-group="' + key + '">' + groupLabels[key] + '</div>';
                items.forEach(s => {
                    html += '<div class="ubbl-toc-item" data-id="' + s.id + '" data-category="' + s.category + '" onclick="scrollToUBBLSection(\'' + s.id + '\')">';
                    html += '<span class="toc-title">' + s.title + '</span>';
                    html += ubblBadgeHTML(s);
                    html += '</div>';
                });
            }
            toc.innerHTML = html;
        }

        function renderUBBLContent(data) {
            const container = document.getElementById('ubbl-content');
            let html = '';
            data.forEach(s => {
                html += '<div class="ubbl-section" id="ubbl-' + s.id + '" data-category="' + s.category + '" data-is2021="' + s.is_new_2021 + '" data-has2021="' + s.has_2021_changes + '">';
                html += '<div class="ubbl-section-header">' + s.title + ' ' + ubblBadgeHTML(s) + '</div>';
                html += '<div class="ubbl-section-body"><div class="md-content">' + marked.parse(s.content) + '</div></div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function scrollToUBBLSection(id) {
            const el = document.getElementById('ubbl-' + id);
            if (!el) return;
            const scrollContainer = document.querySelector('.ubbl-content-area');
            if (scrollContainer) {
                const offset = el.offsetTop - scrollContainer.offsetTop;
                scrollContainer.scrollTo({ top: offset, behavior: 'smooth' });
            } else {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            // Update active TOC item
            document.querySelectorAll('.ubbl-toc-item').forEach(t => t.classList.remove('active'));
            const tocItem = document.querySelector('.ubbl-toc-item[data-id="' + id + '"]');
            if (tocItem) tocItem.classList.add('active');
        }

        function setupUBBLScrollSpy() {
            const sections = document.querySelectorAll('.ubbl-section');
            if (!sections.length) return;
            const scrollContainer = document.querySelector('.ubbl-content-area');
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id.replace('ubbl-', '');
                        document.querySelectorAll('.ubbl-toc-item').forEach(t => t.classList.remove('active'));
                        const tocItem = document.querySelector('.ubbl-toc-item[data-id="' + id + '"]');
                        if (tocItem) tocItem.classList.add('active');
                    }
                });
            }, { root: scrollContainer, rootMargin: '0px 0px -70% 0px' });
            sections.forEach(s => observer.observe(s));
        }

        function filterUBBL(category, btn) {
            ubblActiveFilter = category;
            // Update chip states
            document.querySelectorAll('.ubbl-filter-chips .chip').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const sections = document.querySelectorAll('.ubbl-section');
            const tocItems = document.querySelectorAll('.ubbl-toc-item');
            const tocHeaders = document.querySelectorAll('.ubbl-toc-header');

            sections.forEach(s => {
                const cat = s.dataset.category;
                const is2021 = s.dataset.is2021 === 'true';
                const has2021 = s.dataset.has2021 === 'true';
                let show = category === 'all' || cat === category || (category === '2021' && (is2021 || has2021));
                s.style.display = show ? '' : 'none';
            });

            tocItems.forEach(t => {
                const cat = t.dataset.category;
                const id = t.dataset.id;
                const section = document.getElementById('ubbl-' + id);
                let show = category === 'all' || cat === category;
                if (category === '2021' && section) {
                    show = section.dataset.is2021 === 'true' || section.dataset.has2021 === 'true';
                }
                t.style.display = show ? '' : 'none';
            });

            // Hide empty group headers
            tocHeaders.forEach(h => {
                const group = h.dataset.group;
                const visibleItems = document.querySelectorAll('.ubbl-toc-item[data-category="' + group + '"]');
                let anyVisible = false;
                visibleItems.forEach(i => { if (i.style.display !== 'none') anyVisible = true; });
                // For '2021' filter, check across all groups
                if (category === '2021') {
                    let next = h.nextElementSibling;
                    anyVisible = false;
                    while (next && next.classList.contains('ubbl-toc-item')) {
                        if (next.style.display !== 'none') anyVisible = true;
                        next = next.nextElementSibling;
                    }
                }
                h.style.display = anyVisible ? '' : 'none';
            });

            // Re-apply search if active
            if (ubblSearchQuery) searchUBBL(ubblSearchQuery);
        }

        function searchUBBL(query) {
            ubblSearchQuery = query.trim().toLowerCase();
            const sections = document.querySelectorAll('.ubbl-section');
            const tocItems = document.querySelectorAll('.ubbl-toc-item');

            // Clear previous highlights
            document.querySelectorAll('.search-highlight').forEach(el => {
                const parent = el.parentNode;
                parent.replaceChild(document.createTextNode(el.textContent), el);
                parent.normalize();
            });

            if (!ubblSearchQuery) {
                // Reset visibility to current filter
                filterUBBL(ubblActiveFilter, document.querySelector('.ubbl-filter-chips .chip.active'));
                return;
            }

            sections.forEach(s => {
                // Only search among currently filter-visible sections
                const cat = s.dataset.category;
                const is2021 = s.dataset.is2021 === 'true';
                const has2021 = s.dataset.has2021 === 'true';
                let filterMatch = ubblActiveFilter === 'all' || cat === ubblActiveFilter || (ubblActiveFilter === '2021' && (is2021 || has2021));
                if (!filterMatch) {
                    s.style.display = 'none';
                    return;
                }
                const text = s.textContent.toLowerCase();
                const match = text.includes(ubblSearchQuery);
                s.style.display = match ? '' : 'none';
            });

            // Sync TOC
            tocItems.forEach(t => {
                const id = t.dataset.id;
                const section = document.getElementById('ubbl-' + id);
                t.style.display = section && section.style.display !== 'none' ? '' : 'none';
            });

            // Hide empty TOC headers
            document.querySelectorAll('.ubbl-toc-header').forEach(h => {
                let next = h.nextElementSibling;
                let anyVisible = false;
                while (next && next.classList.contains('ubbl-toc-item')) {
                    if (next.style.display !== 'none') anyVisible = true;
                    next = next.nextElementSibling;
                }
                h.style.display = anyVisible ? '' : 'none';
            });

            // Count visible
            const visible = document.querySelectorAll('.ubbl-section[style=""], .ubbl-section:not([style])').length;
            setStatus(visible + ' section(s) matching "' + ubblSearchQuery + '"');
        }

        // ── Sidebar tools group toggle ────────────────────
        function toggleToolsGroup(label) {
            label.classList.toggle('collapsed');
            const group = label.nextElementSibling;
            if (group) group.classList.toggle('hidden');
        }

        // Auto-expand tools group when a tool tab is selected
        const _origSwitchTab2 = switchTab;
        switchTab = function(tabId, el) {
            _origSwitchTab2(tabId, el);
            if (['search', 'compliance', 'rules'].includes(tabId)) {
                const label = document.querySelector('.sidebar-label-toggle');
                const group = document.querySelector('.tools-group');
                if (label && label.classList.contains('collapsed')) {
                    label.classList.remove('collapsed');
                }
                if (group && group.classList.contains('hidden')) {
                    group.classList.remove('hidden');
                }
            }
        };

        // ── Setup Guide export ────────────────────────────
        function getSetupGuideMarkdown() {
            const sections = [
                '# ARAIDEN — Setup Guide\n',
                '**Repository:** https://github.com/zemang86/cad-ai\n',
            ];
            document.querySelectorAll('#setup .guide-section').forEach(sec => {
                const header = sec.querySelector('.guide-section-header h3');
                if (header) sections.push('## ' + header.textContent.trim() + '\n');
                const body = sec.querySelector('.guide-body');
                if (!body) return;
                body.querySelectorAll('h4, p, ul, ol, .code-block, .config-json, table').forEach(el => {
                    if (el.tagName === 'H4') {
                        sections.push('### ' + el.textContent.trim() + '\n');
                    } else if (el.tagName === 'P') {
                        sections.push(el.textContent.trim() + '\n');
                    } else if (el.tagName === 'UL' || el.tagName === 'OL') {
                        el.querySelectorAll('li').forEach(li => {
                            sections.push('- ' + li.textContent.trim());
                        });
                        sections.push('');
                    } else if (el.classList.contains('code-block') || el.classList.contains('config-json')) {
                        const lines = el.textContent.split('\n').filter(l => !l.includes('Copy'));
                        sections.push('```\n' + lines.join('\n').trim() + '\n```\n');
                    } else if (el.tagName === 'TABLE') {
                        const rows = el.querySelectorAll('tr');
                        rows.forEach((row, i) => {
                            const cells = Array.from(row.querySelectorAll('th, td')).map(c => c.textContent.trim());
                            sections.push('| ' + cells.join(' | ') + ' |');
                            if (i === 0) sections.push('| ' + cells.map(() => '---').join(' | ') + ' |');
                        });
                        sections.push('');
                    }
                });
            });
            return sections.join('\n');
        }

        function downloadSetupGuide() {
            const md = getSetupGuideMarkdown();
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'araiden-setup-guide.md';
            a.click();
            URL.revokeObjectURL(url);
            setStatus('Downloaded setup guide');
        }

        function copySetupGuide(btn) {
            const md = getSetupGuideMarkdown();
            navigator.clipboard.writeText(md).then(() => {
                const span = btn.querySelector('span');
                const orig = span.textContent;
                span.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    span.textContent = orig;
                    btn.classList.remove('copied');
                }, 2000);
                setStatus('Setup guide copied to clipboard');
            });
        }

        // ── Chat ─────────────────────────────────────────
        let chatSessionId = sessionStorage.getItem('chat-session-id');
        if (!chatSessionId) {
            chatSessionId = crypto.randomUUID();
            sessionStorage.setItem('chat-session-id', chatSessionId);
        }
        let chatHistory = [];
        let chatConsentGiven = sessionStorage.getItem('chat-consent') === 'true';
        let chatStreaming = false;

        // Check if chat is enabled on load
        async function checkChatEnabled() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.chat_enabled) {
                    document.getElementById('sidebar-ai-section').style.display = '';
                    const mobileBtn = document.getElementById('mobile-nav-chat');
                    if (mobileBtn) mobileBtn.style.display = '';
                    if (chatConsentGiven) showChatUI();
                }
            } catch (e) { /* ignore */ }
        }
        checkChatEnabled();

        function showChatUI() {
            document.getElementById('consent-banner').style.display = 'none';
            document.getElementById('chat-messages').style.display = 'flex';
            document.getElementById('chat-input-area').style.display = 'flex';
        }

        async function acceptConsent() {
            try {
                await fetch('/api/chat/session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: chatSessionId,
                        consent_given: true,
                        user_agent: navigator.userAgent,
                    }),
                });
            } catch (e) { /* proceed anyway */ }
            chatConsentGiven = true;
            sessionStorage.setItem('chat-consent', 'true');
            showChatUI();
            document.getElementById('chat-input').focus();
        }

        function chatKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChat();
            }
        }

        function appendChatMsg(role, content, messageId) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-msg ' + role;
            if (role === 'assistant') {
                div.innerHTML = '<div class="md-content">' + marked.parse(content || '') + '</div>';
                if (messageId) {
                    div.innerHTML += '<div class="chat-feedback" data-msg-id="' + messageId + '">'
                        + '<button onclick="sendFeedback(\'' + messageId + '\', \'up\', this)" title="Helpful">&#128077;</button>'
                        + '<button onclick="sendFeedback(\'' + messageId + '\', \'down\', this)" title="Not helpful">&#128078;</button>'
                        + '</div>';
                }
            } else {
                div.textContent = content;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-typing';
            div.id = 'chat-typing';
            div.innerHTML = '<span class="dots"><span></span><span></span><span></span></span>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('chat-typing');
            if (el) el.remove();
        }

        async function sendChat() {
            if (chatStreaming) return;
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            input.value = '';
            input.style.height = 'auto';
            appendChatMsg('user', msg);
            chatHistory.push({role: 'user', content: msg});

            chatStreaming = true;
            const sendBtn = document.getElementById('chat-send-btn');
            sendBtn.disabled = true;
            showTypingIndicator();
            setStatus('AI thinking...');

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: chatSessionId,
                        message: msg,
                        conversation_history: chatHistory.slice(-20),
                    }),
                });

                if (!res.ok) {
                    throw new Error('Chat request failed: ' + res.status);
                }

                removeTypingIndicator();
                const assistantDiv = appendChatMsg('assistant', '');
                const mdContent = assistantDiv.querySelector('.md-content');
                let fullText = '';
                let messageId = null;

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, {stream: true});

                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        try {
                            const event = JSON.parse(line.slice(6));
                            if (event.type === 'delta') {
                                fullText += event.content;
                                mdContent.innerHTML = marked.parse(fullText);
                                const container = document.getElementById('chat-messages');
                                container.scrollTop = container.scrollHeight;
                            } else if (event.type === 'done') {
                                messageId = event.message_id;
                            }
                        } catch (e) { /* skip bad lines */ }
                    }
                }

                // Add feedback buttons now that we have message_id
                if (messageId) {
                    const feedbackDiv = document.createElement('div');
                    feedbackDiv.className = 'chat-feedback';
                    feedbackDiv.dataset.msgId = messageId;
                    feedbackDiv.innerHTML =
                        '<button onclick="sendFeedback(\'' + messageId + '\', \'up\', this)" title="Helpful">&#128077;</button>'
                        + '<button onclick="sendFeedback(\'' + messageId + '\', \'down\', this)" title="Not helpful">&#128078;</button>';
                    assistantDiv.appendChild(feedbackDiv);
                }

                chatHistory.push({role: 'assistant', content: fullText});
                setStatus('Ready');
            } catch (e) {
                removeTypingIndicator();
                appendChatMsg('assistant', 'Sorry, an error occurred: ' + e.message);
                setStatus('Error');
            }

            chatStreaming = false;
            sendBtn.disabled = false;
        }

        async function sendFeedback(messageId, rating, btn) {
            const parent = btn.parentElement;
            parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            try {
                await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        message_id: messageId,
                        session_id: chatSessionId,
                        rating: rating,
                    }),
                });
            } catch (e) { /* ignore */ }
        }

        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // ── Browse rule set ──────────────────────────────
        async function browseRuleSet(name, btn) {
            document.querySelectorAll('#rule-set-list .chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const container = document.getElementById('rules-results');
            container.innerHTML = '<div class="loading-msg"><span class="spinner"></span> Loading ' + name + '...</div>';
            setStatus('Loading: ' + name);
            try {
                const res = await fetch('/api/rules/' + name);
                const data = await res.json();
                let html = '<div class="results"><div class="results-header"><span>' + data.source_short + '</span><span class="count">' + data.rules.length + ' rules</span></div>';
                html += '<p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:0.75rem;">' + data.source_document + '</p>';
                data.rules.forEach(r => {
                    html += '<div class="finding severity-' + r.severity + '">';
                    html += '<div class="finding-header"><span class="rule-id">' + r.id + '</span><span class="by-law">' + r.by_law + '</span></div>';
                    html += '<div class="desc">' + r.description + '</div>';
                    html += '<div class="threshold">' + r.check_type + ': ' + r.parameter + ' ' + r.threshold + ' ' + r.unit + '</div>';
                    if (r.tags && r.tags.length) {
                        html += '<div class="tags">' + r.tags.map(t => '<span class="tag">' + t + '</span>').join('') + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
                setStatus(data.rules.length + ' rules in ' + name);
            } catch (e) {
                container.innerHTML = '<div class="card" style="color:var(--red);">Error: ' + e.message + '</div>';
                setStatus('Error');
            }
        }
    </script>
</body>
</html>
